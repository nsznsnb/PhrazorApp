@using PhrazorApp.Models
@using MudBlazor

<DialogBaseWrapper DialogAlertType="DialogAlertType.Info"
                   DialogTitle="ジャンル一括設定"
                   ExecuteButtonText="設定"
                   CancelButtonText="@AppConstants.LABEL_BUTTON_CANCEL"
                   OnExecuteAsync="ApplyAsync">

    <MudStack Spacing="2">
        <MudRadioGroup T="BulkGenreMode" @bind-Value="Mode">
            <MudRadio T="BulkGenreMode" Value="@(BulkGenreMode.ReplaceAll)" Color="Color.Primary">
                既存の設定を差し替える
            </MudRadio>

            <MudRadio T="BulkGenreMode" Value="@(BulkGenreMode.AddMerge)" Color="Color.Primary">
                既存の設定に追加
            </MudRadio>

            <MudRadio T="BulkGenreMode" Value="@(BulkGenreMode.ClearAll)" Color="Color.Primary">
                既存の設定を全てクリア
            </MudRadio>
        </MudRadioGroup>

        @if (Mode != BulkGenreMode.ClearAll)
        {
            <GenreSelectorContainer @ref="_selector"
                              @bind-SelectedItems="_selected"
                              MaxSelection="3"
                              OnAddGenreClicked="OpenGenreDialog" />
        }
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                すべての選択フレーズに対して上記の操作を適用します。
            </MudText>

            @if (Mode != BulkGenreMode.ClearAll)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    ※1フレーズに設定できるジャンルは最大3件です。既に3件ある場合は「既存の設定に追加」を選んでも増えません。
                </MudText>
            }
        </MudStack>
    </MudStack>
</DialogBaseWrapper>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public HashSet<Guid> TargetIds { get; set; } = new();
    [Parameter] public EventCallback<bool> OnApplied { get; set; }

    [Inject] private UiOperationRunner UiOperationRunner { get; set; } = default!;
    [Inject] private PhraseService PhraseService { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;

    private GenreSelectorContainer? _selector;
    private List<DropItemModel> _selected = new();
    private BulkGenreMode Mode = BulkGenreMode.ReplaceAll;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Yield();
            await _selector?.ReloadAsync(_selected)!;
        }
    }

    private async Task OpenGenreDialog()
    {
        var dlg = await DialogService.ShowWithAsync<GenreFormDialogHost, Guid?>(
            title: "ジャンル登録",
            paramSelector: x => x.GenreId,
            value: null,
            options: DialogServiceExtensions.OptionsMd()
        );

        var result = await dlg.Result;
        if (!(result?.Canceled ?? true))
        {
            await _selector!.ReloadAsync(_selected); // 登録直後に再読込
        }

    }

    private async ValueTask<bool> ApplyAsync()
    {
        var ok = await UiOperationRunner.WriteAsync(
            () => PhraseService.SetGenresBulkAsync(TargetIds, _selected, Mode),
            message: AppMessages.MSG_I_PROGRESS_SAVE
        );

        if (!ok.IsSuccess) return false;

        if (OnApplied.HasDelegate) await OnApplied.InvokeAsync(true);
        return true; // ダイアログは成功時に閉じる想定
    }
}
