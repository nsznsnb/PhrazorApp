<MudDialog Class="dialog-root"
           TitleClass="dialog-title"
           ContentClass="@GetContentClass()"
           ActionsClass="dialog-surface">
    <TitleContent>
        <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
            @if (DialogAlertType == DialogAlertType.Error)
            {
                <MudIcon Icon="@Icons.Material.TwoTone.Error" Color="Color.Error" />
            }
            else if (DialogAlertType == DialogAlertType.Warning)
            {
                <MudIcon Icon="@Icons.Material.TwoTone.Warning" Color="Color.Warning" />
            }
            else
            {
                <MudIcon Icon="@Icons.Material.TwoTone.Info" Color="Color.Info" />
            }
            <MudText Typo="Typo.h6">@DialogTitle</MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        @ChildContent
    </DialogContent>

    <DialogActions>
        @if (ShowExecuteButton)
        {
            <MudButton Variant="Variant.Filled"
                       Color="color"
                       Size="@AppConstants.SIZE_BUTTON"
                       OnClick="@OnExecuteInternal">
                @ExecuteButtonText
            </MudButton>
        }
        <MudButton Variant="Variant.Outlined"
                   Size="@AppConstants.SIZE_BUTTON"
                   OnClick="Cancel">
            @CancelButtonText
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
/* 画面全体の調和：薄い暗幕＋わずかなブラーをオーバーレイ側に */
.mud-overlay { 
  background-color: rgba(0,0,0,.28);
  backdrop-filter: blur(3px);
}

/* ダイアログ本体は“面（surface）”のトーンで統一 */
.dialog-root { 
  background: transparent;          /* ルートは透明のまま */
  backdrop-filter: blur(10px);      /* ここでのブラーは本体下にだけ効く */
  border-radius: var(--mud-default-borderradius);
}

/* タイトルは本文と乖離しないようsurface系でほぼ不透明＋区切り線 */
.dialog-title {
  background: rgb(from var(--mud-palette-surface) r g b / 96%);
  color: var(--mud-palette-text-primary);
  border-bottom: 1px solid var(--mud-palette-lines-default);
}

/* 本文・フッターは同じ透明度でそろえる（段差解消） */
.dialog-surface {
  background: rgb(from var(--mud-palette-surface) r g b / 88%);
}

/* 既存の余白調整は維持 */
.mud-dialog .mud-dialog-title { padding: 12px 24px; }
</style>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public DialogAlertType DialogAlertType { get; set; } = DialogAlertType.Info;
    [Parameter] public string DialogTitle { get; set; } = string.Empty;
    [Parameter] public string? ContentClass { get; set; }
    [Parameter] public string ExecuteButtonText { get; set; } = "OK";
    [Parameter] public string CancelButtonText { get; set; } = "キャンセル";
    [Parameter] public bool ShowExecuteButton { get; set; } = true;

    // ★ これだけで制御：true で閉じる / false で閉じない
    [Parameter] public Func<ValueTask<bool>>? OnExecuteAsync { get; set; }

    [Parameter] public RenderFragment? ChildContent { get; set; }

    private Color color => DialogAlertType switch
    {
        DialogAlertType.Info => Color.Primary,
        DialogAlertType.Warning => Color.Warning,
        DialogAlertType.Error => Color.Error,
        _ => Color.Primary
    };

    private string GetContentClass()
        => string.IsNullOrWhiteSpace(ContentClass)
            ? "dialog-surface py-10 my-1"
            : $"dialog-surface {ContentClass}";

    private async Task OnExecuteInternal()
    {
        var canClose = true;
        if (OnExecuteAsync is not null)
            canClose = await OnExecuteAsync();

        if (canClose)
            MudDialog.Close(DialogResult.Ok(string.Empty));
    }

    private void Cancel() => MudDialog.Cancel();
}
