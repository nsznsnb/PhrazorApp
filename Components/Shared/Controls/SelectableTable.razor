@using MudBlazor
@typeparam TItem

<TableWithToolbar TItem="TItem"
                  Title="@Title"
                  Items="@Items"
                  Search="@Search"
                  SearchBy="@SearchBy"
                  SearchPlaceholder="@SearchPlaceholder"
                  Pager="@Pager"
                  RowsPerPage="@RowsPerPage"
                  Height="@Height">

    @* -------- Toolbar（TableWithToolbar のスロット名は ToolbarContent） -------- *@
    <ToolbarContent Context="tb">
        @* TableWithToolbar が持つ現在の検索文字列を同期（再描画要求はしない） *@
        @{
            var txt = tb.SearchText ?? string.Empty;
            var cnt = GetSelectedCountInView(txt);
            var hasRows = HasRows(txt);
            var disabled = cnt == 0 || !hasRows;
            var badgeColor = disabled ? Color.Default : Color.Error;
        }

        @* モバイル：検索結果に対する全選択/解除（FullWidth） *@
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <div style="width:100%">
                <MudCheckBox T="bool"
                             Value="@_selectAll"
                             ValueChanged="@( (bool v) => OnSelectAllChanged(v, txt) )"
                             Dense="true"
                             Disabled="@(!hasRows)"
                             Label="@MobileSelectAllLabel" />
            </div>
        </MudHidden>
        @* 追加ツールバー（必要なときだけ描画） *@
        @if (ExtraToolbar is not null)
        {
            var ctx = new SelectableTableToolbarContext(
            SelectedCountInView: cnt,
            IsMdUp: tb.IsMdUp,
            SearchText: txt,
            GetSelectedIdsInView: () => GetSelectedIdsInView(txt),
            GetSelectedIdsAll: () => new HashSet<Guid>(_selected)
            );

            if (tb.IsMdUp)
            {
                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                    @ExtraToolbar(ctx)
                </MudStack>
            }
            else
            {
                <MudStack Spacing="2" AlignItems="AlignItems.Stretch" Style="width:100%">
                    @ExtraToolbar(ctx)
                </MudStack>
            }
        }
        @* “表示中に含まれる選択数”バッジ（小画面はFullWidth） *@
        <MudBadge Content="@cnt"
                  Max="99999"
                  Color="@badgeColor"
                  Style="@(!tb.IsMdUp ? "width:100%" : null)"
                  Overlap
                  Bordered>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       StartIcon="@Icons.Material.TwoTone.Delete"
                       Disabled="@disabled"
                       FullWidth="@(!tb.IsMdUp)"
                       OnClick="@(() => TriggerBulkDeleteAsync(txt))">
                @BulkDeleteLabel
            </MudButton>
        </MudBadge>
    </ToolbarContent>


    @* -------- Header（左端：選択チェック。デスクトップのみ） -------- *@
    <HeaderContent>
        <MudTh style="width:48px;text-align:center;">
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudCheckBox T="bool"
                             Value="@_selectAll"
                             ValueChanged="@( (bool v) => OnSelectAllChanged(v, _lastSearchText) )"
                             Disabled="@(!HasRows(_lastSearchText))" />
            </MudHidden>
        </MudTh>
        @HeaderContent
    </HeaderContent>


    @* -------- Rows（左端チェック：モバイルはタップ領域拡大） -------- *@
    <RowTemplate Context="row">
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudTd style="width:64px;">
                <div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;"
                     @onclick="@(() => ToggleRow(GetId(row), !IsSelected(GetId(row))))"
                     aria-label="行を選択/解除">
                    <MudCheckBox @key="GetId(row)" T="bool"
                                 Size="Size.Large"
                                 Value="@IsSelected(GetId(row))"
                                 ValueChanged="@( (bool v) => ToggleRow(GetId(row), v) )"
                                 @onclick:stopPropagation="true" />
                </div>
            </MudTd>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudTd style="width:48px;text-align:center; cursor:pointer;"
                   @onclick="@(() => ToggleRow(GetId(row), !IsSelected(GetId(row))))">
                <div @onclick:stopPropagation="true" @onmousedown:stopPropagation="true">
                    <MudCheckBox @key="GetId(row)" T="bool"
                                 Value="@IsSelected(GetId(row))"
                                 ValueChanged="@( (bool v) => ToggleRow(GetId(row), v) )" />
                </div>
            </MudTd>
        </MudHidden>

        @RowTemplate(row)
    </RowTemplate>

    <NoRecordsContent>
        @NoRecordsContent
    </NoRecordsContent>
</TableWithToolbar>

@code {
    // -------- 公開パラメータ（最小） --------
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public Func<TItem, Guid> IdSelector { get; set; } = default!;
    [Parameter] public RenderFragment? HeaderContent { get; set; }
    [Parameter] public RenderFragment<TItem>? RowTemplate { get; set; }
    [Parameter] public RenderFragment? NoRecordsContent { get; set; }

    // オプション：見出し・高さ・ページャ
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Height { get; set; } = "500px";
    [Parameter] public TablePagerMode Pager { get; set; } = TablePagerMode.Auto;
    [Parameter] public int RowsPerPage { get; set; } = 10;

    // オプション：検索
    [Parameter] public bool Search { get; set; } = true;
    [Parameter] public string SearchPlaceholder { get; set; } = "検索";
    /// 検索対象の文字列群を返す（未指定なら ToString()）
    [Parameter] public Func<TItem, IEnumerable<string>>? SearchBy { get; set; }

    // ツールバー拡張（呼び出し側は <ExtraToolbar> を使ってください）
    [Parameter] public RenderFragment<SelectableTableToolbarContext>? ExtraToolbar { get; set; }

    // 一括削除
    [Parameter] public EventCallback<HashSet<Guid>> OnBulkDelete { get; set; }
    [Parameter] public string BulkDeleteLabel { get; set; } = "一括削除";
    [Parameter] public string MobileSelectAllLabel { get; set; } = "全選択（検索結果）";

    // -------- 内部状態 --------
    private HashSet<Guid> _selected = new();
    private bool _selectAll;
    private string _lastSearchText = "";

    [CascadingParameter] public Breakpoint CurrentBreakpoint { get; set; } = Breakpoint.Xl;
    private bool IsMdUp => CurrentBreakpoint >= Breakpoint.Md;

    // Itemsが変わるたびに “存在しない選択” を除去して再計算
    protected override void OnParametersSet()
    {
        PruneSelectionToExistingItems();
        RecalcSelectAll(_lastSearchText);
    }

    // 選択系
    private Guid GetId(TItem item) => IdSelector(item);
    private bool IsSelected(Guid id) => _selected.Contains(id);

    // 現在の検索で表示行があるか
    private bool HasRows(string text) => ItemsView(text).Any();

    // 検索適合
    private bool Matches(TItem item, string text)
    {
        if (!Search || string.IsNullOrWhiteSpace(text)) return true;
        var t = text.Trim();
        if (SearchBy is null)
            return item?.ToString()?.Contains(t, StringComparison.OrdinalIgnoreCase) ?? false;

        foreach (var s in SearchBy(item) ?? Array.Empty<string>())
            if (!string.IsNullOrEmpty(s) && s.Contains(t, StringComparison.OrdinalIgnoreCase))
                return true;
        return false;
    }

    private IEnumerable<TItem> ItemsView(string text)
        => (Items ?? Enumerable.Empty<TItem>()).Where(x => Matches(x, text));

    private void ToggleRow(Guid id, bool isChecked)
    {
        if (isChecked) _selected.Add(id); else _selected.Remove(id);
        RecalcSelectAll(_lastSearchText);
    }


    // 現在のItemsに存在しないIDを _selected から外す
    private void PruneSelectionToExistingItems()
    {
        var ids = (Items ?? Enumerable.Empty<TItem>()).Select(GetId).ToHashSet();
        _selected.RemoveWhere(id => !ids.Contains(id));
    }

    // 全選択フラグの再計算（0件なら必ず false）
    private void RecalcSelectAll(string text)
    {
        var all = ItemsView(text).Select(GetId).ToList();
        _selectAll = all.Count > 0 && all.All(_selected.Contains);
        StateHasChanged();
    }

    // “0件なら反応しない” ガードを追加
    private Task OnSelectAllChanged(bool v, string text)
    {
        if (!HasRows(text))
        {
            _selectAll = false;
            return Task.CompletedTask;
        }

        var idsInView = ItemsView(text).Select(GetId).ToHashSet();
        if (v) foreach (var id in idsInView) _selected.Add(id);
        else _selected.RemoveWhere(idsInView.Contains);

        RecalcSelectAll(text);
        return Task.CompletedTask;
    }
    private int GetSelectedCountInView(string text)
        => ItemsView(text).Select(GetId).Count(_selected.Contains);

    private HashSet<Guid> GetSelectedIdsInView(string text)
        => ItemsView(text).Select(GetId).Where(_selected.Contains).ToHashSet();

    private async Task TriggerBulkDeleteAsync(string text)
    {
        var ids = GetSelectedIdsInView(text);
        if (ids.Count == 0) return;
        if (OnBulkDelete.HasDelegate)
            await OnBulkDelete.InvokeAsync(ids);
    }

    // ツールバー用コンテキスト（名前は大文字で！）
    public readonly record struct SelectableTableToolbarContext(
        int SelectedCountInView,
        bool IsMdUp,
        string SearchText,
        Func<HashSet<Guid>> GetSelectedIdsInView,
        Func<HashSet<Guid>> GetSelectedIdsAll
    );
}