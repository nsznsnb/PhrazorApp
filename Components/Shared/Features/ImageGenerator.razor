@inject ImageService ImageService
@inject UiOperationRunner UiOperationRunner

<MudPaper Class="pa-2" Outlined="true" Style="width: 100%; max-width: 286px;">
    <MudStack Spacing="2" AlignItems="AlignItems.Start" Class="pa-1">
        <MudButton StartIcon="@Icons.Material.TwoTone.ImageSearch"
                   Variant="Variant.Filled"
                   Color="Color.Secondary"
                   Size="@AppConstants.SIZE_BUTTON"
                   OnClick="Generate"
                   FullWidth
                   Disabled="IsLoading || string.IsNullOrWhiteSpace(Prompt)">
            画像生成
        </MudButton>

        @if (IsLoading)
        {
            <MudSkeleton Width="100%" Height="auto" Style="aspect-ratio: 1;" Animation="Animation.Wave" />
        }
        else
        {
            <MudImage Src="@(string.IsNullOrWhiteSpace(ImageUrlInternal) ? "/images/no_img.png" : ImageUrlInternal)"
                      Alt="生成画像"
                      Elevation="25"
                      Fluid="true"
                      Style="aspect-ratio: 1; object-fit: contain;"
                      Class="rounded-lg" />
        }
    </MudStack>
</MudPaper>


@code {
    private bool IsLoading = false;
    private string? ImageUrlInternal;
    private string? ErrorMessage;

    [Parameter, EditorRequired]
    public string? Prompt { get; set; }

    [Parameter, EditorRequired]
    public string? ImageUrl { get; set; }

    [Parameter]
    public EventCallback<string?> ImageUrlChanged { get; set; }

    protected override void OnParametersSet()
    {
        ImageUrlInternal = ImageUrl;
    }

    private async Task Generate()
    {
        if (string.IsNullOrWhiteSpace(Prompt))
            return;

        // 局所UIの無効化用（必要なければ削除OK）
        IsLoading = true;
        ErrorMessage = null;
        ImageUrlInternal = null;
        StateHasChanged();

        var r = await UiOperationRunner.RunAsync(
            ct => ImageService.GenerateImageAsync(Prompt, ct),
            runningMessage: "画像生成中...",
            showCancel: true,
            showAfter: TimeSpan.FromMilliseconds(150) // 150ms 以上かかった場合のみカード表示（ちらつき防止）
        );

        // グローバル Snackbar や例外/キャンセル表示は Runner が処理済み
        if (r.IsSuccess && !string.IsNullOrWhiteSpace(r.Data))
        {
            ImageUrlInternal = r.Data!;
            await ImageUrlChanged.InvokeAsync(ImageUrlInternal);
        }
        else if (r.IsError) // Warning（キャンセルなど）はメッセージ済。必要なら分岐可能
        {
            ErrorMessage = r.Message ?? "画像生成に失敗しました。もう一度お試しください。";
        }

        IsLoading = false;
        StateHasChanged();
    }
}
