@page "/"
@attribute [Authorize]
@inject UiOperationRunner UiOperationRunner
@inject HomeDashboardService DashboardService

<PageTitle>Home</PageTitle>

<MudGrid>

    <!-- 1行目：KPI 3枚（従来どおり） -->
    <!-- 登録フレーズ数 -->
    <MudItem xs="12" sm="6" md="4" lg="4" xl="4">
        <MudPaper Elevation="2" Class="pa-4 rounded-xl" Style="height:200px;">
            <MudStack Spacing="1" Style="height:100%;">
                <MudText Typo="Typo.subtitle2" Style="opacity:.75;">登録フレーズ数</MudText>
                <MudText Typo="Typo.h3" Style="font-size:clamp(1.75rem,6vw,2.5rem);">
                    @(_vm?.RegisteredPhraseCount ?? 0)
                </MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Style="margin-top:auto;">
                    <MudIcon Icon="@Icons.Material.TwoTone.TrendingUp" />
                    <MudText Typo="Typo.caption" Color="Color.Info">
                        今週新規 @ThisWeekNewPhrases 件（先週比 @WeekDeltaSign@Math.Abs(WeekDeltaPercent)%）
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- 習得フレーズ数 -->
    <MudItem xs="12" sm="6" md="4" lg="4" xl="4">
        <MudPaper Elevation="2" Class="pa-4 rounded-xl" Style="height:200px;">
            <MudStack Spacing="1" Style="height:100%;">
                <MudText Typo="Typo.subtitle2" Style="opacity:.75;">習得フレーズ数</MudText>
                <MudText Typo="Typo.h3" Style="font-size:clamp(1.75rem,6vw,2.5rem);">
                    @(_vm?.LearnedPhraseCount ?? 0)
                </MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Style="margin-top:auto;">
                    <MudIcon Icon="@Icons.Material.TwoTone.Bolt" />
                    <MudText Typo="Typo.caption" Color="Color.Success">
                        連続学習 @StudyStreakDays 日
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- 今日の格言 -->
    <MudItem xs="12" sm="12" md="4" lg="4" xl="4">
        <MudPaper Elevation="2" Class="pa-4 rounded-xl" Style="height:200px;">
            <MudStack Spacing="1" Style="height:100%;">
                <MudText Typo="Typo.subtitle2" Style="opacity:.75;">今日のフレーズ（格言）</MudText>

                @if (_vm?.TodayProverb is not null)
                {
                    <MudText Typo="Typo.h6" MaxLines="2">“@_vm.TodayProverb.Text”</MudText>
                    <MudText Typo="Typo.body2" Style="opacity:.8;">— @_vm.TodayProverb.Author</MudText>
                    @if (!string.IsNullOrWhiteSpace(_vm.TodayProverb.Meaning))
                    {
                        <MudText Typo="Typo.caption" Style="opacity:.7; margin-top:4px;" MaxLines="2">
                            @_vm.TodayProverb.Meaning
                        </MudText>
                    }
                }
                else
                {
                    <MudText Typo="Typo.body2" Style="opacity:.7;">格言データがありません。</MudText>
                }

                <span style="margin-top:auto;"></span>
            </MudStack>
        </MudPaper>
    </MudItem>

    <!-- 2行目：グラフ 2枚（カードは従来のPaper。チャートは Width/Height 指定で固定） -->
    <!-- 直近1か月 新規フレーズ登録数（Line／実データのみ） -->
    <MudItem xs="12" sm="12" md="6" lg="6" xl="6">
        <MudPaper Elevation="2" Class="pa-4 rounded-xl">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
                <MudText Typo="Typo.subtitle1">直近1か月 新規フレーズ登録数</MudText>
                <MudText Typo="Typo.caption" Color="Color.Default">日次/推移</MudText>
            </MudStack>

            @if (HasMonthData)
            {
                <MudChart ChartType="ChartType.Line"
                          ChartSeries="@MonthSeries"
                          XAxisLabels="@MonthLabels"
                          ChartOptions="@_chartOptions"
                          AxisChartOptions="@_axisChartOptions"
                          Width="100%" Height="350px" />
            }
            else
            {
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height:350px;">
                    <MudText Typo="Typo.body2" Style="opacity:.7;">直近1か月の登録データがありません</MudText>
                </MudStack>
            }
        </MudPaper>
    </MudItem>

    <!-- 直近テスト 正答率（Line） -->
    <MudItem xs="12" sm="12" md="6" lg="6" xl="6">
        <MudPaper Elevation="2" Class="pa-4 rounded-xl">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
                <MudText Typo="Typo.subtitle1">直近テスト 正答率</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    @if (AvgAccuracy.HasValue)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Info">平均 @AvgAccuracy.Value.ToString("0.#")%</MudText>
                    }
                </MudStack>
            </MudStack>

            @if (HasAccuracyData) @* ★ 0% だけでも表示する *@
            {
                <MudChart ChartType="ChartType.Line"
                          ChartSeries="@AccuracySeries"
                          XAxisLabels="@AccuracyLabels"
                          ChartOptions="@_chartOptions"
                          AxisChartOptions="@_axisChartOptions"
                          Width="100%" Height="350px" />
            }
            else
            {
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height:350px;">
                    <MudText Typo="Typo.body2" Style="opacity:.7;">テスト結果のデータがありません</MudText>
                </MudStack>
            }
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    private HomeDashboardModel? _vm;

    // MudBlazor 8.0 の API を使用
    private readonly AxisChartOptions _axisChartOptions = new() { MatchBoundsToSize = true };
    private readonly ChartOptions _chartOptions = new() { ShowLegend = false };

    protected override async Task OnInitializedAsync()
    {
        _vm = await UiOperationRunner.ReadWithOverlayAsync(
            () => DashboardService.GetAsync(),
            message: AppMessages.MSG_I_PROGRESS_READ
        ) ?? new HomeDashboardModel();
    }

    // === 直近1か月 新規登録（日次） ===
    private bool HasMonthData => _vm?.LastMonthNewPhrases?.Any(p => p.Value > 0) == true;

    private List<ChartSeries> MonthSeries => new()
    {
        new ChartSeries
        {
            Name = string.Empty,
            Data = _vm!.LastMonthNewPhrases.Select(p => (double)p.Value).ToArray()
        }
    };

    // ラベルは詰み防止のため間引き（3日おき）
    private string[] MonthLabels =>
        _vm!.LastMonthNewPhrases
           .Select((p, i) => (i % 3 == 0) ? p.Label : string.Empty)
           .ToArray();

    // === 正答率 ===
    // ★修正箇所：0% でもデータ点があれば表示する
    private bool HasAccuracyData =>
        _vm?.TestAccuracyTimeline is { Count: > 0 };

    private string[] AccuracyLabels =>
        _vm?.TestAccuracyTimeline?.Select(x => x.Label).ToArray() ?? Array.Empty<string>();

    private List<ChartSeries> AccuracySeries => new()
    {
        new ChartSeries
        {
            Name = string.Empty,
            Data = _vm?.TestAccuracyTimeline?.Select(x => (double)x.Value).ToArray() ?? Array.Empty<double>()
        }
    };

    private double? AvgAccuracy
        => (_vm?.TestAccuracyTimeline is { Count: > 0 } tl) ? tl.Select(x => (double)x.Value).Average() : null;

    // KPI 用（既存ロジック）
    private int ThisWeekNewPhrases =>
        (int)(_vm?.WeeklyNewPhrases?.LastOrDefault()?.Value ?? 0);
    private int PrevWeekNewPhrases =>
        (int)(_vm?.WeeklyNewPhrases?.SkipLast(1).LastOrDefault()?.Value ?? 0);
    private int WeekDelta => ThisWeekNewPhrases - PrevWeekNewPhrases;
    private int WeekDeltaPercent =>
        PrevWeekNewPhrases <= 0
            ? (ThisWeekNewPhrases > 0 ? 100 : 0)
            : (int)Math.Round((double)WeekDelta / PrevWeekNewPhrases * 100);
    private string WeekDeltaSign => WeekDelta >= 0 ? "+" : "-";

    // 連続学習日数はサービス側の日別レビュー集計を利用
    private int StudyStreakDays => CalcStreak(_vm?.DailyReviews?.Select(x => (double)x.Value) ?? Enumerable.Empty<double>());
    private static int CalcStreak(IEnumerable<double> counts)
        => counts.Reverse().TakeWhile(c => c > 0d).Count();
}
