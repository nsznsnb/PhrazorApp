@page "/phrases/review"
@page "/tests/review"

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@attribute [Authorize]

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ReviewSession ReviewSession
@inject ProtectedSessionStorage PSS

<MudStack Spacing="2">
    <SectionTitle Title="フレーズ復習" />

    <ActionCard>
        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                   Color="Color.Primary" StartIcon="@Icons.Material.TwoTone.Shuffle"
                   Disabled="@(_count <= 1)" OnClick="Reshuffle">
            シャッフル
        </MudButton>

        <MudButton Variant="Variant.Filled" Size="@AppConstants.SIZE_BUTTON"
                   Color="Color.Primary" StartIcon="@Icons.Material.TwoTone.PlayArrow"
                   Disabled="@(_count == 0)" OnClick="GoWritingTest">
            英作文テストへ
        </MudButton>
    </ActionCard>

    <BaseCard>
        <MudStack Spacing="2" AlignItems="AlignItems.Center" Class="py-4">

            <MudGrid Justify="Justify.Center">
                <MudItem xs="12" sm="10" md="8" lg="7" xl="6">
                    <MudSlider T="int"
                               Min="1"
                               Max="_count"
                               Step="1"
                               Value="_sliderValue"
                               ValueChanged="OnSliderChanged"
                               ValueLabel="true"
                               Disabled="@(_count <= 1)"
                               Color="Color.Primary"
                               Style="width:100%;" />
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.subtitle2">
                @(_count == 0 ? "（データなし）" : $"{_index + 1} / {_count}")
            </MudText>

            <!-- カード -->
            <MudGrid Justify="Justify.Center">
                <MudItem xs="12" sm="10" md="8" lg="7" xl="6">
                    <MudCard Elevation="12"
                             Class="w-100 p-6"
                             Style="height:clamp(240px, 36vh, 420px); cursor:pointer;"
                             @onclick="Flip">
                        <div tabindex="0"
                             @onkeydown="HandleKey"
                             @onkeydown:preventDefault="true"
                             style="outline:none;height:100%;display:flex;flex-direction:column;">

                            <!-- 本文 -->
                            <div style="flex:1 1 auto;display:flex;align-items:center;justify-content:center;overflow:auto;">
                                <MudCardContent Class="w-100">
                                    <MudText Typo="Typo.h5"
                                             Style="word-break:break-word;overflow-wrap:anywhere;">
                                        @(_count == 0 ? "" : _display)
                                    </MudText>
                                </MudCardContent>
                            </div>

                            <!-- クリック指示：幅100%＋Stackで中央寄せ -->
                            <div class="mt-2" style="flex:0 0 auto;min-height:1.5rem;width:100%;">
                                @if (_count > 0)
                                {
                                    <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.caption">
                                            @(_isBack ? "クリック / Space: 表へ" : "クリック / Space: 裏へ")
                                        </MudText>
                                    </MudStack>
                                }
                            </div>
                        </div>
                    </MudCard>
                </MudItem>
            </MudGrid>

            <!-- ナビ -->
            <MudGrid Justify="Justify.Center">
                <MudItem xs="12" sm="10" md="8" lg="7" xl="6">
                    <MudStack Row="true" Spacing="2" Justify="Justify.Center">
                        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                                   StartIcon="@Icons.Material.TwoTone.FirstPage"
                                   Disabled="@(_count <= 0 || _index == 0)" OnClick="GoFirst">
                            先頭へ
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                                   StartIcon="@Icons.Material.TwoTone.ChevronLeft"
                                   Disabled="@(!_canPrev)" OnClick="Prev">
                            前へ
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                                   StartIcon="@Icons.Material.TwoTone.Sync"
                                   Disabled="@(_count == 0)" OnClick="Flip">
                            表/裏
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                                   EndIcon="@Icons.Material.TwoTone.ChevronRight"
                                   Disabled="@(!_canNext)" OnClick="Next">
                            次へ
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" Size="@AppConstants.SIZE_BUTTON"
                                   EndIcon="@Icons.Material.TwoTone.LastPage"
                                   Disabled="@(_count <= 0 || _index == _count - 1)" OnClick="GoLast">
                            最後へ
                        </MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.caption" Class="mt-2">
                ← / → : 前・次　/　Space・Enter : 表裏切替
            </MudText>
        </MudStack>
    </BaseCard>
</MudStack>

@code {
    [Parameter, SupplyParameterFromQuery] public bool? Shuffle { get; set; }
    [Parameter, SupplyParameterFromQuery] public int? Start { get; set; }

    private List<ReviewSession.Card> _items = new();
    private int _index;
    private bool _isBack;
    private int _count;

    private string _display => _isBack ? _items[_index].Back : _items[_index].Front;
    private bool _canPrev => _count > 0 && _index > 0;
    private bool _canNext => _count > 0 && _index < _count - 1;
    private int _sliderValue;

    protected override void OnParametersSet()
    {
        _items = new List<ReviewSession.Card>(ReviewSession.Items);
        _count = _items.Count;
        if (_count == 0)
        {
            Snackbar.Add("復習対象が設定されていません。フレーズ一覧から選択して開始してください。", Severity.Warning);
            NavigationManager.NavigateTo("/phrases");
            return;
        }

        _index = Math.Clamp(Start ?? 0, 0, _count - 1);

        if ((Shuffle ?? false) && _count > 1)
            ShuffleInPlace(_items, null);

        _isBack = false;
        UpdateSlider();
    }

    private void OnSliderChanged(int value)
    {
        if (_count == 0) return;
        var newIndex = Math.Clamp(value - 1, 0, _count - 1);
        if (newIndex != _index)
        {
            _index = newIndex;
            _isBack = false;
        }
        _sliderValue = value;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        if (!Shuffle.HasValue)
        {
            var rShuf = await PSS.GetAsync<bool>("review.shufflePref");
            if (rShuf.Success && rShuf.Value && _count > 1)
            {
                ShuffleInPlace(_items, null);
                _index = 0;
                _isBack = false;
                UpdateSlider();
                StateHasChanged();
            }
        }
    }

    private void Prev() { if (_index > 0) _index--; _isBack = false; UpdateSlider(); }
    private void Next() { if (_index < _count - 1) _index++; _isBack = false; UpdateSlider(); }
    private void GoFirst() { _index = 0; _isBack = false; UpdateSlider(); }
    private void GoLast() { if (_count == 0) return; _index = _count - 1; _isBack = false; UpdateSlider(); }

    private async void Reshuffle()
    {
        if (_count <= 1) return;
        ShuffleInPlace(_items, null);
        _index = 0;
        _isBack = false;
        UpdateSlider();
        await PSS.SetAsync("review.shufflePref", true);
    }

    private void UpdateSlider() => _sliderValue = _index + 1;
    private void Flip() => _isBack = !_isBack;
    private void GoWritingTest() => NavigationManager.NavigateTo("/phrases/writing");

    private static void ShuffleInPlace<T>(IList<T> list, int? seed)
    {
        var rnd = seed.HasValue ? new Random(seed.Value) : new Random();
        for (int i = list.Count - 1; i > 0; i--)
        {
            int j = rnd.Next(i + 1);
            (list[i], list[j]) = (list[j], list[i]);
        }
    }

    private void HandleKey(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "ArrowLeft": Prev(); break;
            case "ArrowRight": Next(); break;
            case " ":
            case "Enter":
                Flip(); break;
        }
    }
}
