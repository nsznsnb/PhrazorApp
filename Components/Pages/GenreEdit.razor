@page "/genres/create"
@page "/genres/edit/{Id:guid}"
@using PhrazorApp.Models
@attribute [Authorize]

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IGenreService GenreService
@inject LoadingService OverlayService


<MudContainer>
    <MudForm Model="@model" @ref="@form" Validation="@(genreValidator.ValidateValue)" ValidationDelay="0">

        <MudStack Spacing="2">
            <SectionTitle Title="@(isEdit ? "フレーズジャンル編集" : "フレーズジャンル新規作成")" />
            <MudCard Elevation="ComDefine.DEFAULT_ELEVATION">
                <MudCardContent Class="py-2">
                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary" StartIcon="@Icons.Material.TwoTone.Save" OnClick="@(async () => await Submit())">@ComDefine.LABEL_BUTTON_REGISTER</MudButton>
                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.TwoTone.Block" OnClick="ClearAsync">@ComDefine.LABEL_BUTTON_CLEAR</MudButton>
                        <MudButton Variant="Variant.Filled" Size="Size.Small" StartIcon="@Icons.Material.TwoTone.NavigateBefore" 　OnClick="@(() => NavigationManager.NavigateTo("/genres"))">@ComDefine.LABEL_BUTTON_RETURN_INDEX</MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
            <MudCard Elevation="ComDefine.DEFAULT_ELEVATION">
                <MudCardHeader Class="py-2">
                    <CardHeaderContent>
                        <SectionTitle HeadingLevel="3" Title="ジャンル入力" />
                    </CardHeaderContent>
                </MudCardHeader>

                <MudCardContent Class="py-2">
                    <MudGrid Spacing="1">
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="@model.Name"
                                          Margin="Margin.Dense" Variant="Variant.Outlined" Label="ジャンル名" For="() => model.Name" ShrinkLabel />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>

            </MudCard>

            <MudTable Items="@model.SubGenres" Dense="true" Hover="true" FixedHeader="true" Height="400px" Bordered="true"
                      Elevation="ComDefine.DEFAULT_ELEVATION" Class="px-4">
                <ToolBarContent>
                    <MudStack Row Spacing="4">
                        <SectionTitle HeadingLevel="3" Icon="@Icons.Material.TwoTone.ListAlt"
                                      Title="サブジャンル一覧入力" />
                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Tertiary" StartIcon="@Icons.Material.TwoTone.Add" OnClick="OnAddButtonClicked">@ComDefine.LABEL_ROW_ADD</MudButton>

                    </MudStack>

                    <MudSpacer />
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>サブジャンル名</MudTh>
                    <MudTh>操作</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>
                        <MudForm Model="@context" Validation=@(subGenreValidator.ValidateValue)>
                            <MudTextField @bind-Value="@context.Name"
                                          Class="pb-2" Margin="Margin.Dense" Variant="Variant.Outlined" Label="サブジャンル名" For="() => model.Name" ShrinkLabel />
                        </MudForm>
                    </MudTd>
                    <MudTd>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.TwoTone.Delete" OnClick="() => OnDeleteButtonClicked(context)">@ComDefine.LABEL_ROW_DELETE</MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default" StartIcon="@Icons.Material.TwoTone.KeyboardArrowUp"
                                   Disabled="@isFirst(context)"
                                   OnClick="@(() => MoveUp(context))">上へ</MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default" StartIcon="@Icons.Material.TwoTone.KeyboardArrowDown"
                                   Disabled="@isLast(context)"
                                   OnClick="@(() => MoveDown(context))">下へ</MudButton>
                    </MudTd>
                </RowTemplate>

            </MudTable>
        </MudStack>
    </MudForm>

</MudContainer>



@code {

    [Parameter]
    public Guid? Id { get; set; }

    MudForm form;


    GenreModelValidator genreValidator = new GenreModelValidator();
    SubGenreModelValidator subGenreValidator = new SubGenreModelValidator();


    /// <summary>
    /// 編集かどうか
    /// </summary>
    private bool isEdit = false;
    /// <summary>
    /// 作成対象モデル
    /// </summary>
    private GenreModel model = new GenreModel();

    protected override async Task OnInitializedAsync()
    {
        isEdit = Id != null ? true : false;
        await ClearAsync();

    }


    private async Task ClearAsync()
    {
        if (isEdit)
        {
            model = await GenreService.GetGenreViewModelAsync(Id.Value);
        }
        else
        {
            model = new() { Id = Guid.NewGuid() };
        }

        if (form != null)
        {
            // バリデーションエラークリア
            form.ResetValidation();
        }

    }


    /// <summary>
    /// 行追加ボタン押下時の処理
    /// </summary>
    /// <returns></returns>
    private void OnAddButtonClicked()
    {


        int nextSortOrder = model.SubGenres.Count > 0
            ? model.SubGenres.Max(x => x.SortOrder) + 1
            : 0;

        model.SubGenres.Add(new SubGenreModel
        {
            Id = Guid.NewGuid(), // 新規作成
            Name = string.Empty,
            SortOrder = nextSortOrder
        });

    }

    /// <summary>
    /// 行削除ボタン押下時の処理
    /// </summary>
    /// <param name="item">選択アイテム</param>
    private void OnDeleteButtonClicked(SubGenreModel item)
    {
        model.SubGenres.Remove(item);
        ReorderSortOrder();
    }

    /// <summary>
    /// ソート順再採番
    /// </summary>
    private void ReorderSortOrder()
    {
        for (int i = 0; i < model.SubGenres.Count; i++)
        {
            model.SubGenres[i].SortOrder = i;
        }
    }

    /// <summary>
    /// 行の上移動
    /// </summary>
    /// <param name="item"></param>
    private void MoveUp(SubGenreModel item)
    {
        var index = model.SubGenres.IndexOf(item);
        if (index > 0)
        {
            (model.SubGenres[index], model.SubGenres[index - 1]) = (model.SubGenres[index - 1], model.SubGenres[index]);
            (model.SubGenres[index].SortOrder, model.SubGenres[index - 1].SortOrder) = (model.SubGenres[index - 1].SortOrder, model.SubGenres[index].SortOrder);

        }
    }

    /// <summary>
    /// 行の下移動
    /// </summary>
    /// <param name="item"></param>
    private void MoveDown(SubGenreModel item)
    {
        var index = model.SubGenres.IndexOf(item);
        if (index < model.SubGenres.Count - 1)
        {
            (model.SubGenres[index], model.SubGenres[index + 1]) = (model.SubGenres[index + 1], model.SubGenres[index]);
            (model.SubGenres[index].SortOrder, model.SubGenres[index + 1].SortOrder) = (model.SubGenres[index + 1].SortOrder, model.SubGenres[index].SortOrder);

        }
    }

    private bool isFirst(SubGenreModel item) => model.SubGenres.First() == item;
    private bool isLast(SubGenreModel item) => model.SubGenres.Last() == item;


    /// <summary>
    /// 登録処理
    /// </summary>
    /// <returns></returns>
    private async Task Submit()
    {
        await form.Validate();

        if (!form.IsValid)
        {
            return;
        }

        // 確認ダイアログ表示
        var dialog = await DialogService.ShowCommonDialogAsync(CommonDialogPattern.RegisterConfirm, string.Format(ComMessage.MSG_I_CONFIRM_REGIST, model.Name));
        var dialogResult = await dialog.Result;

        if (dialogResult!.Canceled)
        {
            return;
        }

        var result = isEdit ? await GenreService.UpdateGenreAsync(model) : await GenreService.CreateGenreAsync(model);
        Snackbar.AddServiceResult(result);

        if (!result.IsSuccess)
        {
            return;
        }

        NavigationManager.NavigateTo("/genres");
    }

}
