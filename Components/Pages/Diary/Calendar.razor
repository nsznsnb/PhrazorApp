@page "/diary/calendar"
@attribute [Authorize]

@using System.Globalization
@using Heron.MudCalendar
@using PhrazorApp.Utils

@inject EnglishDiaryService DiaryService
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject UiOperationRunner UiOperationRunner
@inject IDialogService DialogService

<MudStack Spacing="2">
    <SectionTitle Title="英語日記カレンダー" />

    <ActionCard>
        <MudButton Variant="Variant.Outlined"
                   Size="@AppConstants.SIZE_BUTTON"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.TwoTone.Add"
                   OnClick="CreateToday">
            新規追加
        </MudButton>
    </ActionCard>

    <BaseCard>
        <!-- 月表示のみ。Culture を ja-JP に固定して月名・曜日を日本語化 -->
        <MudCalendar T="DiaryCalendarItem"
                     Items="_items"
                     View="CalendarView.Month"
                     ShowWeek="false"
                     ShowDay="false"
                     Culture="@_ja">
            <CellTemplate Context="item">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="w-100">
                    <!-- 編集へ：JST の日付に正規化して遷移 -->
                    <MudChip T="string"
                             Variant="Variant.Outlined"
                             Color="Color.Primary"
                             Size="Size.Small"
                             Class="flex-grow-1 overflow-hidden text-start"
                             OnClick="@(() => GoToDate(ToTokyoDateOnly(item.Start)))">
                        @StringUtil.Truncate(item.Title)
                    </MudChip>

                    <!-- 削除：JST 日付で削除する -->
                    <MudIconButton Icon="@Icons.Material.TwoTone.Delete"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="@(() => OnClickDeleteAsync(item))" />
                </MudStack>
            </CellTemplate>
        </MudCalendar>
    </BaseCard>
</MudStack>

@code {
    private static readonly CultureInfo _ja = CultureInfo.GetCultureInfo("ja-JP");

    private List<DiaryCalendarItem> _items = new();
    private DateOnly _month = DateOnly.FromDateTime(ToTokyoNow());

    protected override async Task OnInitializedAsync() => await ReloadAsync();

    private async Task ReloadAsync()
    {
        var list = await UiOperationRunner.ReadAsync(() => DiaryService.GetMonthlyItemsAsync(_month));
        _items = list ?? new();
        StateHasChanged();
    }

    private void GoToDate(DateOnly jstDate)
        => Nav.NavigateTo($"/diary/edit/{jstDate:yyyy-MM-dd}");

    private void CreateToday()
    {
        var todayJst = DateOnly.FromDateTime(ToTokyoNow());
        Nav.NavigateTo($"/diary/edit/{todayJst:yyyy-MM-dd}");
    }

    private async Task OnClickDeleteAsync(DiaryCalendarItem item)
    {
        var target = ToTokyoDateOnly(item.Start);
        var ok = await DialogService.ShowConfirmAsync(
            DialogConfirmType.DangerConfirm,
            $"{target:yyyy-MM-dd} の日記を削除します。よろしいですか？"
        );
        if (!ok) return;

        var op = await UiOperationRunner.WriteAsync(
            () => DiaryService.DeleteByDateAsync(target),
            message: "削除しています…"
        );
        if (!op.IsSuccess) return;

        Snackbar.Add("削除しました。", Severity.Success);
        await ReloadAsync();
    }

    // ---- JST ユーティリティ ----
    private static DateTime ToTokyoNow()
    {
        var tz = GetTokyoTz();
        return TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, tz);
    }

    private static DateOnly ToTokyoDateOnly(DateTime dt)
    {
        var tz = GetTokyoTz();
        var d = dt.Kind switch
        {
            DateTimeKind.Utc => TimeZoneInfo.ConvertTimeFromUtc(dt, tz),
            DateTimeKind.Local => TimeZoneInfo.ConvertTime(dt, tz),
            _ => TimeZoneInfo.ConvertTimeFromUtc(DateTime.SpecifyKind(dt, DateTimeKind.Utc), tz)
        };
        return DateOnly.FromDateTime(d);
    }

    private static TimeZoneInfo GetTokyoTz()
    {
        try { return TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time"); }
        catch { return TimeZoneInfo.FindSystemTimeZoneById("Asia/Tokyo"); }
    }
}
