@page "/tests/result"
@attribute [Authorize]

@inject TestResultSession TestResult
@inject ReviewSession ReviewSession
@inject TestResultService TestResultService
@inject GradeService GradeService
@inject UiOperationRunner UiRunner
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@inject JsInteropManager JS

<MudStack Spacing="3" AlignItems="AlignItems.Center">

    <!-- ヘッダ：バッジ + 成績チップ（レスポンシブ配置） -->
    <MudStack Spacing="1" AlignItems="AlignItems.Center">
        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
            <img src="/images/laurel.svg" alt="Result" style="width:120px;height:120px;" />
        </MudHidden>
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <img src="/images/laurel.svg" alt="Result" style="width:96px;height:96px;" />
        </MudHidden>

        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large">
            成績：@(_gradeName ?? LocalGradeSymbol)
        </MudChip>
        <MudText Typo="Typo.h5">テスト結果</MudText>
        <MudText Typo="Typo.subtitle1">
            正解 @TestResult.Correct / 合計 @TestResult.Total（正答率 @((int)(TestResult.Rate() * 100))%）
        </MudText>
    </MudStack>

    <!-- 明細 -->
    <BaseCard>
        <MudTable Items="TestResult.Items" Dense="true" Hover="true" Bordered="false" Striped="true" Breakpoint="Breakpoint.Md">
            <HeaderContent>
                <MudTh>結果</MudTh>
                <MudTh>英作文（Front）</MudTh>
                <MudTh>日本語（Back）</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    @if (context.IsCorrect)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
                    }
                </MudTd>
                <MudTd>@context.Front</MudTd>
                <MudTd>@context.Back</MudTd>
            </RowTemplate>
        </MudTable>
    </BaseCard>

    <!-- ボタン（Sm以下で縦積み） -->
    <MudStack Row="true" Spacing="2" Class="w-100">
        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
            <MudStack Row="true" Spacing="2" Justify="Justify.Center">
                <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="RetestWrong" Disabled="@(_wrongCount == 0)">
                    不正解だけ再テスト
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="RetestAll" Disabled="@(TestResult.Total == 0)">
                    すべて再テスト
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FinishAsync">
                    終了
                </MudButton>
            </MudStack>
        </MudHidden>
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudStack Spacing="2" Class="w-100">
                <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="RetestWrong" Disabled="@(_wrongCount == 0)">
                    不正解だけ再テスト
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="RetestAll" Disabled="@(TestResult.Total == 0)">
                    すべて再テスト
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FinishAsync">
                    終了
                </MudButton>
            </MudStack>
        </MudHidden>
    </MudStack>
</MudStack>

@code {
    private bool _saved;
    private string? _gradeName;
    private int _wrongCount => TestResult.Total - TestResult.Correct;

    // ローカル推定（S/A/B/D）— DBが未解決でも見た目が崩れないように
    private string LocalGradeSymbol
    {
        get
        {
            var pct = (int)(TestResult.Rate() * 100);
            if (pct >= 90) return "S";
            if (pct >= 75) return "A";
            if (pct >= 60) return "B";
            return "D";
        }
    }

    // Result.razor の OnAfterRenderAsync 内（_saved ガードのままでOK）
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _saved) return;

        // ここを UiRunner.WriteAsync に変更（T は Guid）
        var res = await UiRunner.WriteAsync<Guid>(
            () => TestResultService.SaveAsync(TestResult, ReviewSession.Items));

        if (res.IsSuccess)
        {
            _saved = true;
            _gradeName = LocalGradeSymbol; // 表示は即時反映
            Snackbar.Add("テスト結果を保存しました。", Severity.Success);
        }
        else
        {
            Snackbar.Add(res.Message ?? "保存に失敗しました。", Severity.Error);
        }

        StateHasChanged();
    }


    private void RetestWrong()
    {
        var wrong = TestResult.WrongOnly();
        ReviewSession.Set(wrong, x => x.Front, x => x.Back);
        Nav.NavigateTo("/phrases/writing");
    }

    private void RetestAll()
    {
        ReviewSession.Set(TestResult.Items, x => x.Front, x => x.Back);
        Nav.NavigateTo("/phrases/writing");
    }

    private async Task FinishAsync()
    {
        // JS の履歴戻り（fallback: /phrases）
        await JS.HistoryBackAsync("/phrases");
    }
}
